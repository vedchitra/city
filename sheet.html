<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>All Sheets Aggregate with Date Filter</title>
  <style>
    body{font-family: Arial; padding:20px}
    .sheet{margin-bottom:24px; border:1px solid #ddd; padding:12px; border-radius:6px}
    .title{font-weight:700; margin-bottom:8px}
    table{border-collapse:collapse; width:100%}
    th,td{border:1px solid #eee; padding:6px; text-align:left}
    .loading{color:#666}
    .controls{margin-bottom:20px}
    #totalCount{font-weight:bold; margin-left:20px}
  </style>
</head>
<body>
  <h2>Aggregate of multiple Google Sheets</h2>

  <div class="controls">
    <label>Select Date: <input type="date" id="dateFilter"></label>
    <span id="totalCount">Total Rows: 0</span>
  </div>

  <div id="container"></div>

<script>
const sheets = [
  {id:"1_Eo4YYY2DkNwmSyMk52xvy4d_km9fTIjQcY4dAXL_-w", gid:"0", name:"Sheet 1"},
  {id:"18-ppYoq7PrYboz3WerRChDzokv5K-_Eo9OmyB2mCTuQ", gid:"0", name:"Sheet 2"},
  // ... ‡§§‡•Å‡§Æ‡§ö‡•á 20 IDs ‡§á‡§•‡•á
];

const container = document.getElementById('container');
const totalCountEl = document.getElementById('totalCount');
let allData = [];  // {sheetName, headers, rows}

function csvToArray(text){
  const rows = [];
  const lines = text.split(/\r?\n/);
  for(let r of lines){
    if(r.trim()==="") continue;
    const row = [];
    let cur = '', inQuote = false;
    for(let i=0;i<r.length;i++){
      const ch = r[i];
      if(ch === '"' ){
        if(inQuote && r[i+1] === '"'){ cur += '"'; i++; }else{ inQuote = !inQuote; }
      } else if(ch === ',' && !inQuote){
        row.push(cur); cur = '';
      } else { cur += ch; }
    }
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

async function fetchAndStore(sheet){
  const url = `https://docs.google.com/spreadsheets/d/${sheet.id}/export?format=csv&gid=${sheet.gid||0}`;
  const resp = await fetch(url);
  const text = await resp.text();
  const rows = csvToArray(text);
  if(rows.length>0){
    allData.push({
      sheetName: sheet.name || sheet.id,
      headers: rows[0],
      rows: rows.slice(1)
    });
  }
}

function renderData(filterDate){
  container.innerHTML = '';
  let total = 0;
  allData.forEach(data=>{
    const block = document.createElement('div'); block.className='sheet';
    const title = document.createElement('div'); title.className='title'; title.textContent=data.sheetName;
    block.appendChild(title);

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    data.headers.forEach(h=>{ const th=document.createElement('th'); th.textContent = h; headerRow.appendChild(th); });
    thead.appendChild(headerRow); table.appendChild(thead);

    const tbody = document.createElement('tbody');

    // üü¢ filter ‡§≤‡§æ‡§ó‡•Ç
    let dateColIndex = data.headers.findIndex(h=>/date/i.test(h)); // column ‡§®‡§æ‡§µ‡§æ‡§§ "Date" ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞
    data.rows.forEach(row=>{
      let include = true;
      if(filterDate && dateColIndex>=0){
        let cellDate = row[dateColIndex].trim().split(" ")[0]; // yyyy-mm-dd ‡§ï‡§ø‡§Ç‡§µ‡§æ dd/mm/yyyy ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ parse ‡§ï‡§∞‡§§‡§æ ‡§Ø‡•á‡§à‡§≤
        if(cellDate !== filterDate) include = false;
      }
      if(include){
        const tr = document.createElement('tr');
        row.forEach(c=>{ const td=document.createElement('td'); td.textContent=c; tr.appendChild(td); });
        tbody.appendChild(tr);
        total++;
      }
    });

    table.appendChild(tbody);
    block.appendChild(table);
    container.appendChild(block);
  });
  totalCountEl.textContent = `Total Rows: ${total}`;
}

(async ()=>{
  for(const s of sheets) await fetchAndStore(s);
  renderData(null);
})();

// calendar filter event
document.getElementById('dateFilter').addEventListener('change', e=>{
  renderData(e.target.value);
});
</script>
</body>
</html>
